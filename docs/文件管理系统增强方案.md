# 文件管理系统增强方案

## 概述

本方案实现了基于MinIO对象存储的增强文件管理系统，支持文件夹层级管理、自动分类、元数据存储等功能，解决了原系统文件管理的以下问题：

1. 文件存储在本地文件系统，不支持分布式和扩展
2. 缺少文件夹层级管理功能
3. 生成的文件没有正确分类显示
4. 文件元数据管理不完善

## 架构设计

### 1. 核心组件

#### MinIOFileManager (`app/core/minio_file_manager.py`)
- 基于MinIO对象存储的文件管理器
- 支持文件夹层级管理
- 自动文件分类
- 元数据存储和检索

#### FileManagerAdapter (`app/core/file_manager_adapter.py`)
- 统一的文件管理接口
- 支持本地存储和MinIO存储的无缝切换
- 向后兼容现有代码
- 文件迁移功能

### 2. 文件自动分类规则

```python
FILE_CATEGORIES = {
    "generated_charts": {
        "name": "生成图表",
        "path": "generated/charts",
        "filter": lambda meta: meta.get("category") == "analysis_result" and meta.get("file_type") == "image"
    },
    "generated_reports": {
        "name": "分析报告",
        "path": "generated/reports", 
        "filter": lambda meta: meta.get("category") == "analysis_result" and meta.get("file_type") in ["document", "text"]
    },
    "isotope_analysis": {
        "name": "同位素分析",
        "path": "analysis/isotope",
        "filter": lambda meta: meta.get("analysis_type") and "isotope" in meta.get("analysis_type", "")
    },
    # ... 更多分类
}
```

### 3. 文件夹结构

```
isotope-workspace/
├── input/
│   ├── data/          # 输入数据文件
│   ├── logs/          # 测井曲线文件
│   ├── documents/     # 文档资料
│   └── images/        # 图片资料
├── generated/
│   ├── charts/        # 生成的图表
│   ├── reports/       # 分析报告
│   └── models/        # 模型文件
├── analysis/
│   └── isotope/       # 同位素分析结果
└── temp/              # 临时文件
```

## 配置说明

### 1. 启用MinIO存储

在 `app/core/config.py` 中配置：

```python
"storage": {
    "use_minio": True,      # 启用MinIO存储
    "auto_migrate": False   # 是否自动迁移本地文件
}
```

### 2. MinIO连接配置

```python
"minio": {
    "host": "localhost",
    "port": 9000,
    "access_key": "minioadmin",
    "secret_key": "minioadmin",
    "secure": False
}
```

## API接口增强

### 1. 文件夹管理

#### 创建文件夹
```http
POST /api/v1/files/folders/create
Content-Type: application/x-www-form-urlencoded

folder_path=analysis/custom_reports
```

#### 获取文件夹树
```http
GET /api/v1/files/folders/tree?root_path=generated
```

### 2. 批量上传支持文件夹

```http
POST /api/v1/files/batch-upload
Content-Type: multipart/form-data

files: (多个文件)
folder_path: analysis/batch_upload
session_id: xxx
```

### 3. 文件迁移

```http
POST /api/v1/files/migrate-to-minio
```

## 前端集成

### 1. 数据管理中心增强

- 新增文件夹创建功能
- 文件夹树形显示
- 批量上传时可选择目标文件夹
- 文件拖拽到文件夹

### 2. 地质建模中心项目文件树

- 按文件夹层级显示文件
- 自动分类显示（生成图表、分析报告等）
- 支持从不同文件夹导入文件

## 工具集成示例

### 同位素分析工具

```python
# 保存生成的图表到MinIO
file_info = file_manager_adapter.save_file(
    file_data=image_data,
    file_name=output_filename,
    file_type="image",
    source="generated",
    metadata={
        "description": "碳同位素深度趋势分析图",
        "category": "analysis_result",      # 用于自动分类
        "analysis_type": "isotope_depth_trend",
        "chart_type": "trend_plot",
        "geological_model": "true"
    }
)
```

## 迁移指南

### 1. 从本地存储迁移到MinIO

1. 确保MinIO服务正在运行
2. 修改配置文件启用MinIO存储
3. 执行迁移API或运行迁移脚本：

```python
from app.core.file_manager_adapter import get_file_manager

file_manager = get_file_manager()
migrated_count = file_manager.migrate_to_minio()
print(f"迁移完成，共迁移 {migrated_count} 个文件")
```

### 2. 代码兼容性

原有代码无需修改，FileManagerAdapter会自动适配：

```python
# 原代码
from app.core.file_manager import FileManager
file_manager = FileManager.get_instance()

# 新代码（推荐）
from app.core.file_manager_adapter import get_file_manager
file_manager = get_file_manager()
```

## 性能优化

1. **文件缓存**：MinIO客户端自带缓存机制
2. **并发上传**：支持多文件并发上传
3. **懒加载**：文件夹树按需加载子节点
4. **元数据索引**：通过Elasticsearch索引文件元数据

## 安全考虑

1. **访问控制**：MinIO支持细粒度的访问控制策略
2. **加密存储**：支持服务端和客户端加密
3. **审计日志**：所有文件操作都有日志记录
4. **备份恢复**：MinIO支持数据冗余和备份

## 后续优化

1. **文件预览**：集成文件预览功能
2. **版本控制**：支持文件版本管理
3. **协作功能**：文件共享和协作编辑
4. **智能搜索**：基于内容的文件搜索
5. **工作流集成**：文件处理工作流自动化 