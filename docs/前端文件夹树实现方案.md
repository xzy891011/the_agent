# 前端文件夹树实现方案

## 概述
当前前端的"选择文件"对话框使用平铺方式显示所有文件，需要升级为支持分层文件夹的树形显示。

## 实现目标
1. 在数据管理中心和地质建模中心的文件选择器中显示文件夹层级结构
2. 支持创建、展开/折叠文件夹
3. 支持将文件上传到指定文件夹

## 技术方案

### 1. 数据结构设计

```typescript
interface FolderNode {
  path: string;          // 文件夹路径，如 "input/data"
  name: string;          // 文件夹名称
  children: (FolderNode | FileItem)[];  // 子节点
  type: 'folder';
  expanded?: boolean;    // 是否展开
}

interface FileTreeData {
  root: FolderNode;
  fileCount: number;
  folderCount: number;
}
```

### 2. API调用更新

```typescript
// 获取文件夹树结构
const fetchFolderTree = async () => {
  const response = await fetch(`${apiBaseUrl}/api/v1/files/folders/tree`);
  const data = await response.json();
  return buildTreeStructure(data.folders);
};

// 构建树形结构
const buildTreeStructure = (folders: string[]): FolderNode => {
  const root: FolderNode = {
    path: '',
    name: 'Root',
    type: 'folder',
    children: [],
    expanded: true
  };
  
  // 将文件按文件夹分组
  const filesByFolder = new Map<string, FileItem[]>();
  
  // 构建文件夹树...
  return root;
};
```

### 3. UI组件实现

```typescript
// TreeView组件
const FileTreeView: React.FC<{
  data: FolderNode;
  selectedFiles: Set<string>;
  onFileSelect: (fileId: string) => void;
  onFolderCreate?: (parentPath: string) => void;
}> = ({ data, selectedFiles, onFileSelect, onFolderCreate }) => {
  const [expanded, setExpanded] = useState<Set<string>>(new Set(['']));
  
  const toggleFolder = (path: string) => {
    const newExpanded = new Set(expanded);
    if (newExpanded.has(path)) {
      newExpanded.delete(path);
    } else {
      newExpanded.add(path);
    }
    setExpanded(newExpanded);
  };
  
  const renderNode = (node: FolderNode | FileItem, level: number = 0) => {
    if (node.type === 'folder') {
      return (
        <div key={node.path} style={{ marginLeft: level * 20 }}>
          <div 
            className="folder-header"
            onClick={() => toggleFolder(node.path)}
          >
            {expanded.has(node.path) ? '📂' : '📁'} {node.name}
            <span className="file-count">({node.children.length})</span>
          </div>
          {expanded.has(node.path) && (
            <div className="folder-content">
              {node.children.map(child => renderNode(child, level + 1))}
            </div>
          )}
        </div>
      );
    } else {
      // 渲染文件节点
      return (
        <div 
          key={node.file_id} 
          style={{ marginLeft: (level + 1) * 20 }}
          className={`file-item ${selectedFiles.has(node.file_id) ? 'selected' : ''}`}
          onClick={() => onFileSelect(node.file_id)}
        >
          <Checkbox checked={selectedFiles.has(node.file_id)} />
          {getFileIcon(node.file_type, node.file_name)}
          <span>{node.file_name}</span>
        </div>
      );
    }
  };
  
  return <div className="file-tree">{renderNode(data)}</div>;
};
```

### 4. 更新现有组件

修改 `GeologicalModelingHub.tsx` 中的文件选择对话框：

```typescript
// 在对话框中使用树形视图
<DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
  <DialogHeader>
    <DialogTitle>从数据管理中心选择文件</DialogTitle>
    <Button 
      size="sm" 
      variant="outline"
      onClick={() => setShowCreateFolder(true)}
    >
      <FolderPlus className="h-3 w-3 mr-1" />
      新建文件夹
    </Button>
  </DialogHeader>
  
  <div className="mt-4">
    {folderTreeLoading ? (
      <div>加载文件夹结构...</div>
    ) : (
      <FileTreeView
        data={folderTree}
        selectedFiles={selectedForImport}
        onFileSelect={handleImportFileSelect}
        onFolderCreate={handleCreateFolder}
      />
    )}
  </div>
  
  <div className="flex justify-end space-x-2 pt-4 border-t">
    <Button variant="outline" onClick={() => setShowFileSelector(false)}>
      取消
    </Button>
    <Button 
      onClick={importSelectedFiles}
      disabled={selectedForImport.size === 0 || importLoading}
    >
      {importLoading ? '导入中...' : `导入 ${selectedForImport.size} 个文件`}
    </Button>
  </div>
</DialogContent>
```

### 5. 样式定义

```css
.file-tree {
  max-height: 500px;
  overflow-y: auto;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  padding: 12px;
}

.folder-header {
  display: flex;
  align-items: center;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  user-select: none;
}

.folder-header:hover {
  background-color: #f3f4f6;
}

.file-count {
  margin-left: 8px;
  color: #6b7280;
  font-size: 12px;
}

.file-item {
  display: flex;
  align-items: center;
  padding: 4px 8px;
  cursor: pointer;
  border-radius: 4px;
}

.file-item:hover {
  background-color: #f3f4f6;
}

.file-item.selected {
  background-color: #dbeafe;
}
```

## 实施步骤

1. **第一阶段**：实现基础树形显示
   - 创建FileTreeView组件
   - 集成到现有的文件选择对话框
   - 测试基本的展开/折叠功能

2. **第二阶段**：添加文件夹操作
   - 实现创建文件夹功能
   - 支持拖拽文件到文件夹
   - 批量操作支持

3. **第三阶段**：优化体验
   - 添加搜索过滤功能
   - 记住用户的展开状态
   - 性能优化（虚拟滚动）

## 预期效果

完成后，用户将能够：
- 看到清晰的文件夹层级结构
- 快速定位和选择需要的文件
- 创建自定义的文件夹组织结构
- 批量上传文件到指定文件夹

这将大大提升文件管理的效率和用户体验。 