# æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ä¿®å¤æ€»ç»“

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šåœ¨æ•°æ®ç®¡ç†ä¸­å¿ƒä¸­æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ–‡ä»¶é€‰æ‹©å™¨ä¸å¼¹å‡º** - ç‚¹å‡»æ–‡ä»¶å¤¹å³ä¾§å’Œ"å¯¼å…¥æ–‡ä»¶åˆ°æ­¤æ–‡ä»¶å¤¹"æŒ‰é’®åæ²¡æœ‰æ–‡ä»¶é€‰æ‹©å¼¹çª—
2. **ç«‹å³ä¸Šä¼ é—®é¢˜** - é€‰æ‹©æ–‡ä»¶åç›´æ¥å¼€å§‹ä¸Šä¼ ï¼Œç¼ºå°‘ç¡®è®¤æ­¥éª¤  
3. **æ–‡ä»¶ä¸æ˜¾ç¤º** - ä¸Šä¼ å®Œæˆååœ¨å¯¹åº”æ–‡ä»¶å¤¹ä¸‹çœ‹ä¸åˆ°ä¸Šä¼ çš„æ–‡ä»¶
4. **æ‰¹é‡ä¸Šä¼ æŒ‰é’®å†—ä½™** - ç”¨æˆ·å¸Œæœ›åªä¿ç•™ä¸¤ä¸ªä¸Šä¼ å…¥å£

## âœ… ä¿®å¤å†…å®¹

### 1. å‰ç«¯UIä¿®å¤ (DataManager.tsx)

#### ç§»é™¤å†—ä½™æŒ‰é’®
- **ç§»é™¤é¡µé¢é¡¶éƒ¨çš„"ä¸Šä¼ æ–‡ä»¶"æŒ‰é’®** (ç¬¬1383è¡Œ)
- **ç§»é™¤æ–‡ä»¶åˆ—è¡¨ä¸­çš„"æ‰¹é‡ä¸Šä¼ "æŒ‰é’®** (ç¬¬1112è¡Œ)

#### ä¿®å¤æ–‡ä»¶é€‰æ‹©å™¨
- **æ·»åŠ æ–‡ä»¶é€‰æ‹©æŒ‰é’®** åˆ°"ä¸Šä¼ æ–‡ä»¶åˆ°æ–‡ä»¶å¤¹å¯¹è¯æ¡†"ä¸­
- **ä¿®å¤æ–‡ä»¶é€‰æ‹©è§¦å‘** - æ·»åŠ `onClick`äº‹ä»¶æ­£ç¡®è§¦å‘`input[type="file"]`
- **æ”¹è¿›ç”¨æˆ·ä½“éªŒ** - é€‰æ‹©æ–‡ä»¶åå…³é—­å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºç¡®è®¤ç•Œé¢

#### ä¼˜åŒ–ä¸Šä¼ ååˆ·æ–°
- **è‡ªåŠ¨é€‰æ‹©ä¸Šä¼ æ–‡ä»¶å¤¹** - ä¸Šä¼ å®Œæˆåè‡ªåŠ¨é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹
- **åˆ·æ–°æ–‡ä»¶å¤¹æ ‘** - ç¡®ä¿æ–°ä¸Šä¼ çš„æ–‡ä»¶èƒ½ç«‹å³æ˜¾ç¤º
- **å±•å¼€ç›®æ ‡æ–‡ä»¶å¤¹** - è‡ªåŠ¨å±•å¼€åŒ…å«æ–°æ–‡ä»¶çš„æ–‡ä»¶å¤¹

### 2. åç«¯APIä¿®å¤

#### æ‰¹é‡ä¸Šä¼ API (files.py)
```python
# æ„å»ºåŒ…å«folder_pathçš„å…ƒæ•°æ®
complete_metadata = {
    **file_metadata,
    "content_type": file.content_type,
    "size": len(file_content)
}

# å¦‚æœæŒ‡å®šäº†folder_pathï¼Œæ·»åŠ åˆ°å…ƒæ•°æ®ä¸­
if folder_path:
    complete_metadata["folder_path"] = folder_path
    complete_metadata["path"] = folder_path
```

#### æ–‡ä»¶ç®¡ç†å™¨é€‚é…å™¨ (file_manager_adapter.py)
```python
# æœ¬åœ°å­˜å‚¨åˆ†æ”¯ - æ·»åŠ folder_pathåˆ°metadata
local_metadata = metadata.copy() if metadata else {}
if folder_path:
    local_metadata["folder_path"] = folder_path
    local_metadata["path"] = folder_path
```

#### æœ¬åœ°æ–‡ä»¶ç®¡ç†å™¨ (file_manager.py)
```python
# ä¿®å¤è¿”å›å€¼ - è¿”å›å®Œæ•´file_infoè€Œä¸æ˜¯file_id
return file_info  # è€Œä¸æ˜¯ return file_id
```

#### MinIOæ–‡ä»¶ç®¡ç†å™¨ (minio_file_manager.py)
```python
# ä¿å­˜å‰æ·»åŠ folder_pathåˆ°å®Œæ•´å…ƒæ•°æ®
if folder_path:
    full_metadata["folder_path"] = folder_path
    full_metadata["path"] = folder_path

# è¿”å›æ—¶ä½¿ç”¨å®Œæ•´å…ƒæ•°æ®
"metadata": full_metadata.copy()

# get_fileæ–¹æ³•æ·»åŠ metadataå­—æ®µæ„å»º
file_info["metadata"] = {}
for key, value in metadata.items():
    if key.startswith("x-amz-meta-") and key not in [...]:
        meta_key = key.replace("x-amz-meta-", "")
        file_info["metadata"][meta_key] = self._decode_metadata_value(value)
```

#### æ–‡ä»¶å¤¹æ ‘APIä¿®å¤ (files.py)
```python
# ä»æ–‡ä»¶å…ƒæ•°æ®ä¸­æå–æ–‡ä»¶å¤¹ä¿¡æ¯
folder_path = f.get("metadata", {}).get("folder_path") or f.get("metadata", {}).get("path")
if folder_path:
    folders.add(folder_path)

tree = {
    "folders": list(folders),  # ç¡®ä¿æ˜¯æ•°ç»„æ ¼å¼
    "files": file_list
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç»“æœ
- âœ… **æ–‡ä»¶é€‰æ‹©å™¨æ­£å¸¸å¼¹å‡º**
- âœ… **ç¡®è®¤å¯¹è¯æ¡†æ­£å¸¸æ˜¾ç¤º**  
- âœ… **æ–‡ä»¶æˆåŠŸä¸Šä¼ åˆ°æŒ‡å®šæ–‡ä»¶å¤¹**
- âœ… **folder_pathå…ƒæ•°æ®æ­£ç¡®ä¿å­˜**
- âœ… **ä¸Šä¼ åæ–‡ä»¶åˆ—è¡¨æ­£ç¡®æ˜¾ç¤º**
- âœ… **æ–‡ä»¶å¤¹æ ‘åŒ…å«æ–°åˆ›å»ºçš„æ–‡ä»¶å¤¹**

### æµ‹è¯•æ•°æ®ç¤ºä¾‹
```json
{
  "file_id": "u-dedaae01",
  "file_name": "test_file.txt", 
  "metadata": {
    "folder_path": "test_upload_folder",
    "path": "test_upload_folder",
    "upload_time": "2025-07-02T21:35:16.721371"
  }
}
```

## ğŸ”§ å…³é”®æŠ€æœ¯è¦ç‚¹

### å­˜å‚¨æ¶æ„
- **MinIOå­˜å‚¨ä¼˜å…ˆ** - ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨MinIOå¯¹è±¡å­˜å‚¨
- **æœ¬åœ°å­˜å‚¨å…¼å®¹** - ä¿æŒå‘åå…¼å®¹æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
- **å…ƒæ•°æ®ç¼–ç ** - MinIOå…ƒæ•°æ®ä½¿ç”¨URLç¼–ç å¤„ç†ä¸­æ–‡

### æ–‡ä»¶è·¯å¾„å¤„ç†
- **è‡ªå®šä¹‰è·¯å¾„** - `folder_path`å‚æ•°ä¼˜å…ˆçº§é«˜äºè‡ªåŠ¨åˆ†ç±»
- **å…ƒæ•°æ®å†—ä½™** - åŒæ—¶ä¿å­˜`folder_path`å’Œ`path`å­—æ®µç¡®ä¿å…¼å®¹æ€§
- **è·¯å¾„æ ‡å‡†åŒ–** - ç»Ÿä¸€å¤„ç†è·¯å¾„åˆ†éš”ç¬¦å’Œæ ¼å¼

### å‰ç«¯çŠ¶æ€ç®¡ç†
- **è‡ªåŠ¨åˆ·æ–°** - ä¸Šä¼ åå¹¶è¡Œè°ƒç”¨`fetchFiles()`å’Œ`fetchFolderTree()`
- **çŠ¶æ€åŒæ­¥** - ç¡®ä¿æ–‡ä»¶å¤¹é€‰æ‹©çŠ¶æ€ä¸ä¸Šä¼ ç»“æœåŒæ­¥
- **ç”¨æˆ·åé¦ˆ** - æä¾›æ˜ç¡®çš„ä¸Šä¼ æˆåŠŸ/å¤±è´¥æç¤º

## ğŸ“‹ ç”¨æˆ·ç•Œé¢æ”¹è¿›

### ä¿ç•™çš„ä¸Šä¼ å…¥å£ (2ä¸ª)
1. **æ–‡ä»¶å¤¹å³ä¾§ä¸Šä¼ æŒ‰é’®** - é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºï¼Œç›´æ¥ä¸Šä¼ åˆ°ç‰¹å®šæ–‡ä»¶å¤¹
2. **"å¯¼å…¥æ–‡ä»¶åˆ°æ­¤æ–‡ä»¶å¤¹"æŒ‰é’®** - é€‰ä¸­æ–‡ä»¶å¤¹æ—¶æ˜¾ç¤ºï¼Œæ˜ç¡®ä¸Šä¼ ç›®æ ‡

### ä¸Šä¼ æµç¨‹
1. ç‚¹å‡»ä¸Šä¼ æŒ‰é’® â†’ å¼¹å‡ºæ–‡ä»¶å¤¹ä¸Šä¼ å¯¹è¯æ¡†
2. ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’® â†’ æ‰“å¼€ç³»ç»Ÿæ–‡ä»¶é€‰æ‹©å™¨
3. é€‰æ‹©æ–‡ä»¶å â†’ å…³é—­å¯¹è¯æ¡†ï¼Œæ˜¾ç¤ºç¡®è®¤ç•Œé¢
4. ç¡®è®¤ä¸Šä¼  â†’ å¼€å§‹ä¸Šä¼ ï¼Œæ˜¾ç¤ºè¿›åº¦
5. ä¸Šä¼ å®Œæˆ â†’ è‡ªåŠ¨åˆ·æ–°ï¼Œé€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹

## ğŸš€ éƒ¨ç½²è¯´æ˜

### æ›´æ–°çš„æ–‡ä»¶
- `app/ui/petro_agent/components/DataManager.tsx`
- `app/api/routes/files.py` 
- `app/core/file_manager_adapter.py`
- `app/core/file_manager.py`
- `app/core/minio_file_manager.py`

### é‡å¯è¦æ±‚
- **åç«¯æœåŠ¡éœ€è¦é‡å¯** æ‰èƒ½åŠ è½½ä¿®æ”¹åçš„ä»£ç 
- **å‰ç«¯æ— éœ€é‡å¯** (Next.jsçƒ­æ›´æ–°æ”¯æŒ)

## âœ¨ æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰
- âŒ ç‚¹å‡»ä¸Šä¼ æŒ‰é’®æ— ååº”
- âŒ æ–‡ä»¶é€‰æ‹©åç«‹å³ä¸Šä¼   
- âŒ ä¸Šä¼ åçœ‹ä¸åˆ°æ–‡ä»¶
- âŒ folder_pathä¸ºnull

### ä¿®å¤å  
- âœ… æ–‡ä»¶é€‰æ‹©å™¨æ­£å¸¸å¼¹å‡º
- âœ… æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
- âœ… æ–‡ä»¶æ­£ç¡®æ˜¾ç¤ºåœ¨ç›®æ ‡æ–‡ä»¶å¤¹
- âœ… folder_pathæ­£ç¡®ä¿å­˜

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-07-02  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡  
**ç”¨æˆ·ä½“éªŒ**: ğŸš€ æ˜¾è‘—æ”¹å–„ 