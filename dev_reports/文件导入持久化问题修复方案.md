# 文件导入和持久化问题修复方案

## 问题描述

用户反馈两个关键问题：
1. **文件导入问题**：在"地质建模中心"选择文件并导入后，文件树中看不到选择导入的文件
2. **持久化问题**：run_api.py重启后，数据管理中心里的数据又不见了

## 问题根因分析

### 1. 持久化问题根因

通过测试发现，文件管理器本身工作正常（能正确返回1596个文件），但API接口返回0个文件。问题在于：

- `app/api/routes/files.py`中的`list_files`函数原本使用`engine.sessions`来获取文件，这只能获取当前内存中的会话文件
- 应该直接从文件管理器的索引中获取所有文件

### 2. 文件导入问题根因

- 前端在导入完成后虽然调用了`fetchFiles()`刷新，但由于后端数据同步延迟，可能导致文件列表未及时更新
- 需要增加适当的延迟和状态管理

## 解决方案实施

### 1. 修复API文件列表功能

修改`app/api/routes/files.py`中的以下函数：

```python
# list_files函数
- 从 engine.sessions 获取文件
+ 从 file_manager.get_all_files() 获取文件

# get_file_statistics函数  
- 从 engine.sessions 获取文件
+ 从 file_manager.get_all_files() 获取文件

# get_data_quality函数
- 从 engine.sessions 获取文件  
+ 从 file_manager.get_all_files() 获取文件

# search_files函数
- 从 engine.sessions 获取文件
+ 使用 file_manager.search_files() 搜索
```

### 2. 优化前端导入逻辑

修改`app/ui/petro_agent/components/GeologicalModelingHub.tsx`：

```javascript
// 导入完成后增加延迟
await new Promise(resolve => setTimeout(resolve, 1000));  // 等待后端同步
await fetchFiles();  // 刷新文件列表
await new Promise(resolve => setTimeout(resolve, 500));   // 确保UI更新
```

### 3. 修复测试脚本

修正`test_persistence_and_import.py`中会话创建响应解析：

```python
result = response.json()
session_id = result.get('data', {}).get('session_id')  # 从data字段获取
```

## 验证步骤

1. **重启API服务器**（重要！）
   ```bash
   # 停止当前运行的 run_api.py
   # 重新启动
   conda activate sweet
   python run_api.py
   ```

2. **运行测试脚本验证**
   ```bash
   python test_file_manager_direct.py  # 验证文件管理器工作正常
   python test_persistence_and_import.py  # 验证API功能
   ```

3. **前端测试**
   - 上传文件到数据管理中心
   - 在地质建模中心导入文件
   - 验证文件立即出现在文件树中
   - 重启API服务器
   - 验证文件仍然存在

## 核心修改文件

1. `app/api/routes/files.py` - 修复文件列表API使用文件管理器
2. `app/ui/petro_agent/components/GeologicalModelingHub.tsx` - 优化导入后刷新逻辑
3. `test_persistence_and_import.py` - 修复测试脚本响应解析

## 预期结果

1. **持久化功能**：API重启后，所有文件数据仍然保留
2. **导入功能**：文件导入后立即在文件树中可见
3. **性能优化**：直接从文件索引读取，避免遍历内存会话

## 注意事项

- 必须重启API服务器才能使修改生效
- 文件索引存储在`data/file_index.json`
- 文件管理器使用单例模式，确保数据一致性 